trigger:
- develop*
- feature*
- master

pr:
- develop*
- feature*

resources:
  repositories:
    - repository: templates
      type: github
      name: deltics/azure-pipeline-templates
      endpoint: GitHubTemplates
      ref: refs/heads/develop

pool:
  name: $(AgentPool)
  demands: Delphi

variables:
  dugetLogLevel: info

steps:
- template: gitversion.yml@templates

- script: |
    duget init --log:$(dugetLogLevel)
    duget restore --path tests --log:$(dugetLogLevel)
  displayName: 'Restore Duget dependencies'

- template: build-all.yml
  parameters:
    delphiVersions: [ 7, 2005, 2006, 2007, 2009, 2010, xe, xe2, xe3, xe4, xe5, xe6, xe7, xe8, 10, 10.1, 10.2, 10.3 ]

- template: build-all.yml
  parameters:
    delphiVersions: [ xe2, xe3, xe4, xe5, xe6, xe7, xe8, 10, 10.1, 10.2, 10.3 ]
    platform: x64

- template: test-all.yml
  parameters:
    delphiVersions: [ 7, 2005, 2006, 2007, 2009, 2010, xe, xe2, xe3, xe4, xe5, xe6, xe7, xe8, 10, 10.1, 10.2, 10.3 ]

- template: test-all.yml
  parameters:
    delphiVersions: [ xe2, xe3, xe4, xe5, xe6, xe7, xe8, 10, 10.1, 10.2, 10.3 ]
    platform: x64

- task: PublishTestResults@2
  inputs:
    testResultsFormat: XUnit
    testResultsFiles: '*.xml'
    searchFolder: '.results'
    testRunTitle: Build $(gitversion)
    condition: succeededOrFailed()

- powershell: duget pack --version $(gitversion) --log:$(dugetLogLevel)
  displayName: Create Duget package

- powershell: |
    $feed = '$(gitversionprelabel)'
    if ($feed -eq '') {
        $feed = 'release'
    }
    duget push --feed:$feed --log:$(dugetLogLevel)
  displayName: Publish Duget package